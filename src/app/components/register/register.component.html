<div class="container-scroller">
  <div class="container-fluid page-body-wrapper full-page-wrapper">
    <div class="row w-100">
      <div class="content-wrapper full-page-wrapper d-flex align-items-center auth login-bg">
        <div class="card col-lg-6 mx-auto">
          <div class="card-body px-5 py-5">
            <h3 class="card-title text-start mb-3">Créer un compte</h3>

            <form [formGroup]="registerForm" (ngSubmit)="register()">

              <!-- CIN -->
              <div class="form-group">
                <label for="cin">CIN</label>
                <input type="text" id="cin" formControlName="cin" class="form-control p_input"
                  placeholder="Entrez votre CIN (8 chiffres)">
                <div *ngIf="registerForm.get('cin')?.invalid && registerForm.get('cin')?.touched" class="text-danger">
                  Le CIN doit contenir 8 chiffres.
                </div>
              </div>

              <!-- Nom complet -->
              <div class="form-group">
                <label for="name">Nom complet</label>
                <input type="text" id="name" formControlName="name" class="form-control p_input"
                  placeholder="Entrez votre nom complet">
                <div *ngIf="registerForm.get('name')?.invalid && registerForm.get('name')?.touched" class="text-danger">
                  Le nom est requis.
                </div>
              </div>

              <!-- Email -->
              <div class="form-group">
                <label for="email">Email</label>
                <input type="email" id="email" formControlName="email" class="form-control p_input"
                       placeholder="exemple@domaine.com">
                <div *ngIf="registerForm.get('email')?.errors?.['required'] && registerForm.get('email')?.touched"
                     class="text-danger">
                  L'e-mail est requis.
                </div>
                <div *ngIf="registerForm.get('email')?.errors?.['email'] && registerForm.get('email')?.touched"
                     class="text-danger">
                  Format de l'e-mail invalide.
                </div>
              </div>

              <!-- Photo de profil -->
              <div class="form-group">
                <label for="photo">Photo de profil</label>
                <input type="file" id="photo" (change)="onFileSelected($event)" class="form-control p_input" accept="image/*">
                
                <!-- Aperçu et statut de vérification -->
                <div *ngIf="imagePreview" class="mt-3">
                  <div class="d-flex align-items-center">
                    <img [src]="imagePreview" alt="Image Preview" class="img-thumbnail me-3" width="100" height="100">
                    
                    <div>
                      <div *ngIf="isVerifyingFace" class="text-info">
                        <i class="fas fa-spinner fa-spin"></i> Vérification du visage en cours...
                      </div>
                      
                      <div *ngIf="faceVerificationResult" 
                           [class.text-success]="faceVerificationResult.isValid"
                           [class.text-danger]="!faceVerificationResult.isValid">
                        <i class="fas" 
                           [class.fa-check-circle]="faceVerificationResult.isValid"
                           [class.fa-times-circle]="!faceVerificationResult.isValid"></i>
                        {{ faceVerificationResult.message || 
                           (faceVerificationResult.isValid ? 'Visage validé' : 'Visage non valide') }}
                      </div>
                    </div>
                  </div>
                  
                  <small class="text-muted d-block mt-2">
                    La photo doit clairement montrer votre visage (pas de lunettes sombres, pas de masque)
                  </small>
                </div>
              </div>

              <!-- Mot de passe -->
              <div class="form-group">
                <label for="password">Mot de passe</label>
                <input type="password" id="password" formControlName="password" class="form-control p_input"
                  placeholder="Entrez un mot de passe (min. 6 caractères)">
                <div *ngIf="registerForm.get('password')?.invalid && registerForm.get('password')?.touched" class="text-danger">
                  Le mot de passe doit contenir au moins 6 caractères.
                </div>
              </div>

              <!-- Confirmation mot de passe -->
              <div class="form-group">
                <label for="confirmPassword">Confirmer mot de passe</label>
                <input type="password" id="confirmPassword" formControlName="confirmPassword"
                  class="form-control p_input" placeholder="Confirmez le mot de passe">
                <div *ngIf="registerForm.get('confirmPassword')?.value !== registerForm.get('password')?.value && registerForm.get('confirmPassword')?.touched" class="text-danger">
                  Les mots de passe ne correspondent pas.
                </div>
              </div>

              <!-- Téléphone -->
              <div class="form-group">
                <label for="phone">Téléphone</label>
                <input type="text" id="phone" formControlName="phone" class="form-control p_input"
                       placeholder="Entrez votre numéro de téléphone (min. 8 chiffres)">
                <div *ngIf="registerForm.get('phone')?.invalid && registerForm.get('phone')?.touched" class="text-danger">
                  <small>Veuillez entrer un numéro valide avec le format +216XXXXXXXX.</small>
                </div>
              </div>

              <!-- Adresse -->
              <div class="form-group">
                <label for="address">Adresse</label>
                <input type="text" id="address" formControlName="address" class="form-control p_input"
                  placeholder="Entrez votre adresse">
                <div *ngIf="registerForm.get('address')?.invalid && registerForm.get('address')?.touched" class="text-danger">
                  L'adresse est requise.
                </div>
              </div>

              <!-- Date de naissance -->
              <div class="form-group">
                <label for="dateDeNaissance">Date de naissance</label>
                <input type="date" id="dateDeNaissance" formControlName="dateDeNaissance"
                  class="form-control p_input">
                <div *ngIf="registerForm.get('dateDeNaissance')?.invalid && registerForm.get('dateDeNaissance')?.touched"
                  class="text-danger">
                  La date de naissance est requise.
                </div>
              </div>

              <!-- Genre -->
              <div class="form-group">
                <label>Genre</label>
                <select formControlName="genre" class="form-control p_input placeholder-select">
                  <option value="" disabled selected>Sélectionnez votre genre</option>
                  <option value="Homme">Homme</option>
                  <option value="Femme">Femme</option>
                  <option value="Autre">Autre</option>
                </select>
                <div *ngIf="registerForm.get('genre')?.invalid && registerForm.get('genre')?.touched" class="text-danger">
                  Veuillez sélectionner un genre.
                </div>
              </div>

              <!-- Rôle -->
              <div class="form-group">
                <label>Rôle</label>
                <select formControlName="role" class="form-control p_input placeholder-select">
                  <option value="" disabled selected hidden>Sélectionnez votre rôle</option>
                  <option value="BORROWER">Emprunteur</option>
                  <option value="OWNER">Propriétaire</option>
                </select>
                <div *ngIf="registerForm.get('role')?.invalid && registerForm.get('role')?.touched" class="text-danger">
                  Le rôle est requis.
                </div>
              </div>

              <!-- Conditions générales -->
              <div class="form-check mb-3">
                <input type="checkbox" id="terms" formControlName="terms" class="form-check-input">
                <label class="form-check-label" for="terms">
                  J'accepte les termes et conditions
                </label>
                <div *ngIf="registerForm.get('terms')?.invalid && registerForm.get('terms')?.touched" class="text-danger">
                  Vous devez accepter les termes.
                </div>
              </div>

              <!-- Message d'erreur global -->
              <div *ngIf="errorMessage" class="text-danger text-center mb-2">{{ errorMessage }}</div>

              <!-- Bouton de soumission -->
              <div class="text-center d-grid gap-2">
                <button type="submit" class="btn btn-success btn-block enter-btn" [disabled]="loading">
                  <span *ngIf="loading" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                  S'inscrire
                </button>
              </div>

              <!-- Lien de connexion -->
              <p class="sign-up text-center mt-3">
                Vous avez déjà un compte ? <a routerLink="/login">Se connecter</a>
              </p>

            </form>

          </div>
        </div>
      </div>
    </div>
  </div>
</div>
