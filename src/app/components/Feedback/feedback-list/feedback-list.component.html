<!-- Error message -->
<div *ngIf="errorMessage" class="error-message">
  <p>{{ errorMessage }}</p>
</div>

<!-- Feedback list -->
<div *ngIf="feedbacks.length > 0; else noFeedback">
  <div class="feedback-container">
    <ul>
      <li *ngFor="let feedback of feedbacks; trackBy: trackByFeedbackId"
          [ngClass]="{'popular': getFeedbackPopularityScore(feedback) >= 5}"
          class="feedback-card">

        <!-- Three-dot menu icon -->
        <div style="float: right; position: relative;">
          <span (click)="toggleMenu(feedback.id)" style="cursor: pointer;">⋮</span>
          <div *ngIf="openedMenuFeedbackId === feedback.id" class="dropdown-menu">
            <button (click)="startEditing(feedback)">✏️ Edit</button>
            <button (click)="openReportModal(feedback)" [disabled]="feedback.reported">🚩 Report</button>
            <button (click)="deleteFeedback(feedback.id)">🗑️ Delete</button>
          </div>
        </div>

        <!-- Message or edit form -->
        <div *ngIf="editingFeedbackId === feedback.id; else normalMessage">
          <textarea [(ngModel)]="editedMessage" rows="3"></textarea>
          <br>
          <button (click)="submitEdit(feedback)">💾 Save</button>
          <button (click)="cancelEditing()">❌ Cancel</button>
        </div>
        <ng-template #normalMessage>
          <h3>{{ feedback.message }}</h3>
        </ng-template>

        <!-- Popular badge -->
        <small *ngIf="getFeedbackPopularityScore(feedback) >= 5" class="badge">🔥 Popular</small>

        <!-- User Info Section -->
        <div class="user-info">
          <img [src]="feedback.user?.avatar || defaultProfileImage" 
               alt="{{ feedback.user?.name }}" 
               class="user-avatar"
               onerror="this.src='assets/images/Capture.png'">
          <div>
            <p class="user-name"><strong>{{ feedback.user?.name || 'Name not available' }}</strong></p>
            <p class="feedback-date">{{ feedback.date | date:'medium' }}</p>
            <small *ngIf="editingFeedbackId === feedback.id" style="color: #666;">
              User ID: {{feedback.user?.id}}, Name: {{feedback.user?.name}}
            </small>
          </div>
        </div>

        <!-- Facebook-style Reaction System -->
        <div class="reaction-container">
          <!-- Reaction Summary -->
          <div class="reaction-summary" (click)="openReactionModal(feedback)">
            <div class="reaction-totals">
              <span *ngFor="let reaction of getTopReactions(feedback)" class="reaction-badge">
                {{ getReactionEmoji(reaction) }} {{ getReactionCount(feedback.reacts || [], reaction) }}
              </span>
              <span *ngIf="getTotalReactions(feedback) > 0" class="total-count">
                {{ getTotalReactions(feedback) }}
              </span>
            </div>
          </div>

         <!-- In your feedback card template -->
<div class="reaction-bar">
  <div class="reaction-button-container" 
       (mouseenter)="showReactionPicker(feedback)"
       (mouseleave)="hideReactionPickerWithDelay(feedback)">
    <div class="reaction-button">
      <span class="reaction-emoji">👍</span>
      <span class="reaction-label">Like</span>
    </div>
    
    <!-- Reaction Picker -->
    <div class="reaction-picker" *ngIf="activePicker === feedback.id" 
         (mouseenter)="cancelHideReactionPicker()"
         (mouseleave)="hideReactionPicker(feedback)">
      <div class="reaction-option" 
           *ngFor="let reaction of reactions"
           (click)="handleReaction(feedback, reaction)"
           [class.active]="feedback.currentUserReaction === reaction">
        <span class="picker-emoji">{{ getReactionEmoji(reaction) }}</span>
        <span class="picker-label">{{ eactionLabels[reaction] }}</span>
      </div>
    </div>
  </div>
</div>
        </div>

        <!-- View reactions button -->
        <button class="view-reactions-btn" (click)="openReactionModal(feedback)">
          📊 View all reactions
        </button>

        <!-- Reactions list -->
        <div *ngIf="feedback.showReacts">
          <p *ngFor="let reaction of reactions">
            {{ getReactionEmoji(reaction) }} : {{ getReactionCount(feedback.reacts || [], reaction) }}
          </p>
        </div>
      </li>
    </ul>
  </div>
</div>

<!-- No feedback template -->
<ng-template #noFeedback>
  <p>No feedback found.</p>
</ng-template>

<!-- Reactions modal -->
<div *ngIf="activeFeedback" class="modal-overlay">
  <div class="modal">
    <h2>Reactions:</h2>
    <button (click)="closeModal()">❌ Close</button>
    <div class="tabs">
      <button *ngFor="let reaction of reactions" (click)="selectTab(reaction)">
        {{ getReactionEmoji(reaction) }}
      </button>
      <button (click)="selectTab('ALL')">📋 All</button>
    </div>

    <!-- Reactions list with detailed user info -->
    <div *ngIf="activeFeedback?.reacts?.length; else noReacts" class="reaction-list">
      <div *ngFor="let react of filteredReacts" class="reaction-item">
        <div class="user-info">
          <img [src]="react.user?.avatar || defaultProfileImage" 
               alt="{{ react.user?.name }}" 
               class="user-avatar"
               onerror="this.src='assets/images/Capture.png'">
          <div class="user-details">
            <span class="user-name">{{ react.user?.name || 'Anonymous' }}</span>
            <small *ngIf="react.user?.email" class="user-email">{{ react.user?.email }}</small>
            <small *ngIf="react.user?.phone" class="user-phone">{{ react.user?.phone }}</small>
          </div>
        </div>
        <div class="reaction-info">
          <span class="reaction-emoji">{{ getReactionEmoji(react.reaction) }}</span>
          <span class="reaction-type">{{ react.reaction }}</span>
          <span class="reaction-date">{{ react.date | date:'short' }}</span>
        </div>
      </div>
    </div>
    <ng-template #noReacts>
      <p style="color: red;">❌ No reactions found.</p>
    </ng-template>
  </div>
</div>

<!-- Report modal -->
<div *ngIf="reportModalOpen" class="modal-overlay">
  <div class="modal">
    <h2>🚩 Report feedback</h2>
    <p>Message: "{{ reportingFeedback?.message }}"</p>
    <textarea [(ngModel)]="reasonForReport" placeholder="Please provide a reason..." rows="3"></textarea>
    <br>
    <button (click)="reportFeedback()">✅ Report</button>
    <button (click)="closeReportModal()">❌ Cancel</button>
  </div>
</div>