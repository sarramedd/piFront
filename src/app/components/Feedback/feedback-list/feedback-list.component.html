<!-- Error message -->
<div *ngIf="errorMessage" class="error-message">
  <p>{{ errorMessage }}</p>
</div>

<!-- Feedback list -->
<div *ngIf="feedbacks.length > 0; else noFeedback">
  <div class="feedback-container">
    <ul>
      <li *ngFor="let feedback of feedbacks; trackBy: trackByFeedbackId"
          [ngClass]="{'popular': getFeedbackPopularityScore(feedback) >= 5}"
          class="feedback-card">

        <!-- Three-dot menu icon -->
        <div style="float: right; position: relative;">
          <span (click)="toggleMenu(feedback.id)" style="cursor: pointer;">⋮</span>
          <div *ngIf="openedMenuFeedbackId === feedback.id" class="dropdown-menu">
            <button (click)="startEditing(feedback)">✏️ Edit</button>
            <button (click)="openReportModal(feedback)" [disabled]="feedback.reported">🚩 Report</button>
            <button (click)="deleteFeedback(feedback.id)">🗑️ Delete</button>
          </div>
        </div>

        <!-- Message or edit form -->
        <div *ngIf="editingFeedbackId === feedback.id; else normalMessage">
          <textarea [(ngModel)]="editedMessage" rows="3"></textarea>
          <br>
          <button (click)="submitEdit(feedback)">💾 Save</button>
          <button (click)="cancelEditing()">❌ Cancel</button>
        </div>
        <ng-template #normalMessage>
          <h3>{{ feedback.message }}</h3>
        </ng-template>

        <!-- Popular badge -->
        <small *ngIf="getFeedbackPopularityScore(feedback) >= 5" class="badge">🔥 Popular</small>

        <!-- User Info Section -->
        <div class="user-info">
          <img [src]="feedback.user?.avatar || defaultProfileImage" 
               alt="{{ feedback.user?.name }}" 
               class="user-avatar"
               onerror="this.src='assets/images/Capture.png'">
          <div>
            <p class="user-name"><strong>{{ feedback.user?.name || 'Name not available' }}</strong></p>
            <p class="feedback-date">{{ feedback.date | date:'medium' }}</p>
          </div>
        </div>

        <p><strong>Total reactions:</strong> {{ getTotalReactions(feedback) }}</p>

       <!-- Reaction buttons -->
<div class="reaction-buttons">
  <!-- Like Button -->
  <button (click)="handleReaction(feedback, 'LIKE')" 
          [class.active]="feedback.currentUserReaction === 'LIKE'">
    👍 {{ getReactionCount(feedback.reacts || [], 'LIKE') }}
  </button>

  <!-- Dislike Button -->
  <button (click)="handleReaction(feedback, 'DISLIKE')"
          [class.active]="feedback.currentUserReaction === 'DISLIKE'">
    👎 {{ getReactionCount(feedback.reacts || [], 'DISLIKE') }}
  </button>
  
  <!-- Love Button -->
  <button (click)="handleReaction(feedback, 'LOVE')"
          [class.active]="feedback.currentUserReaction === 'LOVE'">
    ❤️ {{ getReactionCount(feedback.reacts || [], 'LOVE') }}
  </button>

  <!-- Laugh Button -->
  <button (click)="handleReaction(feedback, 'LAUGH')"
          [class.active]="feedback.currentUserReaction === 'LAUGH'">
    😂 {{ getReactionCount(feedback.reacts || [], 'LAUGH') }}
  </button>

  <!-- Sad Button -->
  <button (click)="handleReaction(feedback, 'SAD')"
          [class.active]="feedback.currentUserReaction === 'SAD'">
    😢 {{ getReactionCount(feedback.reacts || [], 'SAD') }}
  </button>

  <!-- Angry Button -->
  <button (click)="handleReaction(feedback, 'ANGRY')"
          [class.active]="feedback.currentUserReaction === 'ANGRY'">
    😡 {{ getReactionCount(feedback.reacts || [], 'ANGRY') }}
  </button>

  <!-- View reactions button -->
  <button (click)="openReactionModal(feedback)">📊 View reactions</button>
</div>

        <!-- Reactions list -->
        <div *ngIf="feedback.showReacts">
          <p *ngFor="let reaction of reactions">
            {{ getReactionEmoji(reaction) }} : {{ getReactionCount(feedback.reacts || [], reaction) }}
          </p>
        </div>
      </li>
    </ul>
  </div>
</div>

<!-- No feedback template -->
<ng-template #noFeedback>
  <p>No feedback found.</p>
</ng-template>

<!-- Reactions modal -->
<div *ngIf="activeFeedback" class="modal-overlay">
  <div class="modal">
    <h2>Reactions:</h2>
    <button (click)="closeModal()">❌ Close</button>
    <div class="tabs">
      <button *ngFor="let reaction of reactions" (click)="selectTab(reaction)">
        {{ getReactionEmoji(reaction) }}
      </button>
      <button (click)="selectTab('ALL')">📋 All</button>
    </div>

    <!-- Reactions list with detailed user info -->
    <div *ngIf="activeFeedback?.reacts?.length; else noReacts" class="reaction-list">
      <div *ngFor="let react of filteredReacts" class="reaction-item">
        <div class="user-info">
          <img [src]="react.user?.avatar || defaultProfileImage" 
               alt="{{ react.user?.name }}" 
               class="user-avatar"
               onerror="this.src='assets/images/Capture.png'">
          <div class="user-details">
            <span class="user-name">{{ react.user?.name || 'Anonymous' }}</span>
            <small *ngIf="react.user?.email" class="user-email">{{ react.user?.email }}</small>
            <small *ngIf="react.user?.phone" class="user-phone">{{ react.user?.phone }}</small>
          </div>
        </div>
        <div class="reaction-info">
          <span class="reaction-emoji">{{ getReactionEmoji(react.reaction) }}</span>
          <span class="reaction-type">{{ react.reaction }}</span>
          <span class="reaction-date">{{ react.date | date:'short' }}</span>
        </div>
      </div>
    </div>
    <ng-template #noReacts>
      <p style="color: red;">❌ No reactions found.</p>
    </ng-template>
  </div>
</div>

<!-- Report modal -->
<div *ngIf="reportModalOpen" class="modal-overlay">
  <div class="modal">
    <h2>🚩 Report feedback</h2>
    <p>Message: "{{ reportingFeedback?.message }}"</p>
    <textarea [(ngModel)]="reasonForReport" placeholder="Please provide a reason..." rows="3"></textarea>
    <br>
    <button (click)="reportFeedback()">✅ Report</button>
    <button (click)="closeReportModal()">❌ Cancel</button>
  </div>
</div>